<project name="gengfoSimpleProject" basedir="." default="all">

	<!--
	setup build file
	1. build ear
	2. deploy ear
	3. coding test ws
	4. build ws jar	
	5. http://gengfo:8888/CONTEXT-ROOT/URL-PATTERN
	-->

	<target name="loadporperties" description="load porperties">
		<property file="build.properties" />
		<echo message="URL ---> http://${j2ee.server}:${j2ee.port}/${CONTEXT-ROOT}/${URL-PATTERN}" />
		<path id="packageJARRef">
			<!--
			<fileset dir="${compile.lib.ref.root}">
				<include name="**/*.jar" />
				<include name="**/*.xml" />
			</fileset>
			-->
		</path>

	</target>

	<target name="cleandist" depends="loadporperties" description="delete dist folder">
		<delete dir="${dist.root}" failonerror="false" />
	</target>

	<target name="init" depends="loadporperties">

		<mkdir dir="${dist.root}" />
		<mkdir dir="${dist.root}/jar/classes" />
		<mkdir dir="${dist.root}/ear/temp/META-INF" />
		<mkdir dir="${dist.root}/war/temp/WEB-INF" />

	</target>

	<target name="compile" depends="init">
		<javac	srcdir="${src.root}" 
			destdir="${dist.root}/jar/classes" 
			includes="**/**" 
			classpathref="packageJARRef" 
			encoding="UTF-8" 
			debug="true" 
			optimize="true" />
	</target>

	<target name="packageJAR" depends="compile">
		<jar	destfile="${dist.root}/jar/${APP-JAR}" 
			basedir="${dist.root}/jar/classes" 
			includes="**/**" />
	</target>

	<!--
		1. copy web.xml 
		2. copy application.xml
		3. copy orion-application.xml
	-->
	<target name="initEarFiles" depends="init,loadporperties">

		<copy file="${ear.res.root}/CONTEXT-ROOT/META-INF/application.xml" todir="${dist.root}/ear/temp/META-INF" />
		<replace file="${dist.root}/ear/temp/META-INF/application.xml">
			<replacefilter token="%%WEB-URI%%" value="${WEB-URI}" />
			<replacefilter token="%%CONTEXT-ROOT%%" value="${CONTEXT-ROOT}" />
		</replace>

		<copy file="${ear.res.root}/CONTEXT-ROOT/META-INF/orion-application.xml" todir="${dist.root}/ear/temp/META-INF" />
		<replace file="${dist.root}/ear/temp/META-INF/orion-application.xml">
			<replacefilter token="%%LIBRARY-PATH%%" value="${LIBRARY-PATH}" />
		</replace>

		<copy file="${ear.res.root}/CONTEXT-ROOT/CONTEXT-ROOT-web/WEB-INF/web.xml" todir="${dist.root}/war/temp/WEB-INF" />
		<replace file="${dist.root}/war/temp/WEB-INF/web.xml">
			<replacefilter token="%%SERVLET-NAME%%" value="${SERVLET-NAME}" />
			<replacefilter token="%%SERVLET-CLASS%%" value="${SERVLET-CLASS}" />
			<replacefilter token="%%INIT-PARAM-1-NAME%%" value="${INIT-PARAM-1-NAME}" />
			<replacefilter token="%%INIT-PARAM-1-VALUE%%" value="${INIT-PARAM-1-VALUE}" />
			<replacefilter token="%%INIT-PARAM-2-NAME%%" value="${INIT-PARAM-2-NAME}" />
			<replacefilter token="%%INIT-PARAM-2-VALUE%%" value="${INIT-PARAM-2-VALUE}" />
			<replacefilter token="%%URL-PATTERN%%" value="${URL-PATTERN}" />
		</replace>

	</target>



	<!--
		1. build war
		2. remove web.xml
	-->
	<target name="packageWAR">
		<war warfile="${dist.root}/war/${WEB-URI}" webxml="${dist.root}/war/temp/WEB-INF/web.xml" />

		<copy file="${dist.root}/war/${WEB-URI}" todir="${dist.root}/ear/temp" />
	</target>

	<!--
		1. build ear
	-->
	<target name="packageEAR" depends="initEarFiles,packageWAR">

		<jar jarfile="${dist.root}/ear/${CONTEXT-ROOT}.ear" basedir="${dist.root}/ear/temp" />

	</target>

	<target name="copyEARToOC4J" depends="loadporperties">

		<copy file="${dist.root}/ear/${CONTEXT-ROOT}.ear" todir="${j2ee.home}/applications" />

	</target>


	<target name="copyAppJARToOC4J" depends="loadporperties">

		<copy file="${dist.root}/jar/${APP-JAR}" todir="${LIBRARY-PATH}" />

	</target>

	<!--			
	<target name="copyXFireJARToOC4J" depends="loadporperties">

		<copy todir="${j2ee.home}/xfire-test">
			<fileset dir="${xfire.libs.root}" />
		</copy>

		<copy file="${dist.root}/jar/testapp.jar" todir="" />

	</target>
	-->

	<target name="standaloneoc4j-deploy">

		<waitfor maxwait="10" maxwaitunit="second" timeoutproperty="oc4j.missing">
			<socket port="${j2ee.port}" server="${j2ee.server}" />
		</waitfor>

		<fail if="oc4j.missing">OC4J is not up and running, please check!</fail>

		<java jar="${j2ee.home}/admin_client.jar" fork="true" dir=".">
			<arg value="${deploy.url}" />
			<arg value="${oc4j.adminid}" />
			<arg value="${oc4j.adminpwd}" />
			<arg value="-deploy" />
			<arg value="-file" />
			<arg value="${j2ee.home}/applications/${CONTEXT-ROOT}.ear" />
			<arg value="-deploymentName" />
			<arg value="${CONTEXT-ROOT}" />
			<arg value="-bindAllWebApps" />
		</java>

	</target>

	<target name="all" depends="loadporperties">
			
		<antcall target="cleandist" />			
		<antcall target="packageJAR" />
		<antcall target="packageEAR" />
		
		<!--
		<antcall target="copyEARToOC4J" />
		
		-->
		
		<!--
		<antcall target="copyAppJARToOC4J" />
		<antcall target="standaloneoc4j-deploy" />
		-->

	</target>

</project>